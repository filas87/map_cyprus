<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Κύπρος – TK Finder</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    html,body{height:100%;margin:0}
    body{display:grid;grid-template-columns:minmax(320px,1fr) 420px;height:100%}
    #map{position:relative;height:100vh;min-height:320px;width:100%}
    #panel{border-left:1px solid #e5e7eb;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;overflow:auto;padding:12px}
    h1{font-size:16px;margin:0 0 6px}
    small{color:#64748b}
    button{padding:8px 10px;border:0;border-radius:8px;background:#111827;color:#fff;font-weight:600;cursor:pointer}
    button.secondary{background:#e5e7eb;color:#111827}
    button+button{margin-left:8px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:8px 0}
    .item{border-top:1px dashed #e5e7eb;padding:6px 0}
    .muted{color:#6b7280}
    .list{font-size:12px;color:#334155;max-height:160px;overflow:auto}
    .ok{background:#d1fae5;color:#065f46;border-radius:9999px;padding:2px 8px;margin-left:6px}
  </style>
</head>
<body>
  <div id="map"></div>
  <aside id="panel">
    <h1>Κύπρος – TK Finder <span class="ok">v2.16.0</span></h1>
    <div id="status">Εκκίνηση…</div>
    <div class="row">
      <input id="searchInput" placeholder="ΤΚ 4 ψηφίων ή διεύθυνση" style="flex:1;padding:8px;border:1px solid #e5e7eb;border-radius:8px"/>
      <button id="searchBtn">Αναζήτηση</button>
      <button class="secondary" id="clearSearchBtn">Καθαρισμός</button>
    </div>
    <div id="searchResults" class="list"></div>
    <div class="row">
      <button id="addMarkerBtn">Προσθήκη Marker</button>
      <button class="secondary" id="reassignBtn">Ανακατανομή</button>
      <button class="secondary" id="toggleLabelsBtn">Labels TK</button>
      <button class="secondary" id="exportCsvBtn">CSV</button>
      <button class="secondary" id="exportXlsxBtn">Excel</button>
    </div>
    <div class="row">
      <input type="file" id="fileInput" accept=".geojson,.json,.csv,.txt" style="display:none"/>
      <button class="secondary" id="importBtn">Εισαγωγή επίσημου GeoJSON/CSV</button>
      <button class="secondary" id="clearCacheBtn">Καθαρισμός cache</button>
    </div>
    <div class="row">
      <button class="secondary" id="pasteListBtn">Εισαγωγή λίστας ΤΚ (χωρίς συντετ.)</button>
    </div>
    <div class="row" id="pasteBox" style="display:none;flex-direction:column;gap:6px">
      <textarea id="pasteArea" placeholder="Επικόλλησε εδώ ΤΚ (π.χ. 1010,1011 ή ένας ανά γραμμή)" style="width:100%;height:110px;padding:8px;border:1px solid #e5e7eb;border-radius:8px"></textarea>
      <div>
        <button id="geocodeListBtn">Γεωκωδικοποίηση λίστας</button>
        <small class="muted">Χρησιμοποιεί Nominatim (σειριακά) & αποθήκευση σε cache.</small>
      </div>
    </div>
    <div class="row" style="border-top:1px dashed #e5e7eb;padding-top:8px">
      <strong>GitHub Cloud Save</strong>
    </div>
    <div class="row" style="gap:6px">
      <input id="ghOwner" placeholder="owner" style="width:120px;padding:8px;border:1px solid #e5e7eb;border-radius:8px"/>
      <input id="ghRepo" placeholder="repo" style="width:140px;padding:8px;border:1px solid #e5e7eb;border-radius:8px"/>
      <input id="ghBranch" placeholder="branch (π.χ. main)" style="width:140px;padding:8px;border:1px solid #e5e7eb;border-radius:8px"/>
    </div>
    <div class="row" style="gap:6px">
      <input id="ghPath" placeholder="path (state.json)" value="state.json" style="flex:1;padding:8px;border:1px solid #e5e7eb;border-radius:8px"/>
    </div>
    <div class="row" style="gap:6px">
      <input id="ghToken" type="password" placeholder="GitHub Token (repo:contents)" style="flex:1;padding:8px;border:1px solid #e5e7eb;border-radius:8px"/>
      <button id="ghSaveBtn">GitHub Save</button>
      <button class="secondary" id="ghLoadBtn">GitHub Load</button>
    </div>
    <div class="row" style="border-top:1px dashed #e5e7eb;padding-top:8px">
      <strong>Γρήγορη διόρθωση ΤΚ</strong>
    </div>
    <div class="row" id="quickEditRow" style="gap:6px;align-items:flex-start">
      <input id="qePostcode" placeholder="ΤΚ (4 ψηφία)" style="width:90px;padding:8px;border:1px solid #e5e7eb;border-radius:8px"/>
      <input id="qeLat" placeholder="lat" style="width:120px;padding:8px;border:1px solid #e5e7eb;border-radius:8px"/>
      <input id="qeLon" placeholder="lon" style="width:120px;padding:8px;border:1px solid #e5e7eb;border-radius:8px"/>
      <button class="secondary" id="qePick">Pick από χάρτη</button>
      <button id="qeApply">Ενημέρωση ΤΚ</button>
    </div>
    <div class="row">
      <button class="secondary" id="saveStateBtn">Αποθήκευση κατάστασης (JSON)</button>
      <button class="secondary" id="loadStateBtn">Φόρτωση κατάστασης</button>
    </div>
    <div class="item">
      <div class="muted">Markers</div>
      <div id="markers"></div>
    </div>
    <div class="item">
      <div class="muted">Σύνοψη</div>
      <div id="summary"></div>
    </div>
  </aside>
<script>
const map=L.map('map').setView([35.1667,33.3667],10);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'© OpenStreetMap',maxZoom:19}).addTo(map);
const statusDiv=document.getElementById('status');
const addMarkerBtn=document.getElementById('addMarkerBtn');
const reassignBtn=document.getElementById('reassignBtn');
const exportCsvBtn=document.getElementById('exportCsvBtn');
const exportXlsxBtn=document.getElementById('exportXlsxBtn');
const toggleLabelsBtn=document.getElementById('toggleLabelsBtn');
const searchInput=document.getElementById('searchInput');
const searchBtn=document.getElementById('searchBtn');
const clearSearchBtn=document.getElementById('clearSearchBtn');
const searchResults=document.getElementById('searchResults');
const markersDiv=document.getElementById('markers');
const summaryDiv=document.getElementById('summary');
const importBtn=document.getElementById('importBtn');
const clearCacheBtn=document.getElementById('clearCacheBtn');
const fileInput=document.getElementById('fileInput');
const pasteListBtn=document.getElementById('pasteListBtn');
const pasteBox=document.getElementById('pasteBox');
const pasteArea=document.getElementById('pasteArea');
const geocodeListBtn=document.getElementById('geocodeListBtn');
const qePostcode=document.getElementById('qePostcode');
const qeLat=document.getElementById('qeLat');
const qeLon=document.getElementById('qeLon');
const qePick=document.getElementById('qePick');
const qeApply=document.getElementById('qeApply');
const saveStateBtn=document.getElementById('saveStateBtn');
const loadStateBtn=document.getElementById('loadStateBtn');
const ghOwner=document.getElementById('ghOwner');
const ghRepo=document.getElementById('ghRepo');
const ghBranch=document.getElementById('ghBranch');
const ghPath=document.getElementById('ghPath');
const ghToken=document.getElementById('ghToken');
const ghSaveBtn=document.getElementById('ghSaveBtn');
const ghLoadBtn=document.getElementById('ghLoadBtn');
let labelsVisible=true;
const tkLayer=L.geoJSON(null,{pointToLayer:(f,latlng)=>L.circleMarker(latlng,{radius:3,weight:1,color:'#2563eb',fillColor:'#3b82f6',fillOpacity:.7}).bindTooltip('ΤΚ '+String(f.properties.postcode),{permanent:labelsVisible,offset:[8,0],direction:'right'})}).addTo(map);
const searchLayer=L.layerGroup().addTo(map);
const markersLayer=L.layerGroup().addTo(map);
let tkIndex=new Map();
let registry=[];let nextId=1;let addMode=false;
function setLabels(v){labelsVisible=v;tkLayer.eachLayer(l=>{v?l.openTooltip():l.closeTooltip()});}
function fromCSV(csv){const lines=String(csv).trim().split(/\r?\n/).filter(Boolean);if(!lines.length)return[];const head=lines[0].split(',').map(s=>s.trim().toLowerCase());const idx=(names)=>{for(let i=0;i<names.length;i++){const k=names[i];const j=head.indexOf(k);if(j>-1)return j;}return -1;};const iP=idx(['postcode','post_code','tk','postalcode','postal_code']);const iLa=idx(['lat','latitude','y']);const iLo=idx(['lon','lng','longitude','x']);if(iP<0||iLa<0||iLo<0)throw new Error('Το CSV πρέπει να έχει στήλες: postcode, lat, lon');const feats=[];for(let i=1;i<lines.length;i++){const p=lines[i].split(',');const pc=(p[iP]||'').trim();const la=parseFloat(p[iLa]);const lo=parseFloat(p[iLo]);if(pc&&isFinite(la)&&isFinite(lo)){feats.push({type:'Feature',properties:{postcode:String(pc)},geometry:{type:'Point',coordinates:[lo,la]}});}}return feats;}
function toCSV(feats){const header='postcode,lat,lon\n';const body=feats.map(f=>String(f.properties.postcode)+','+f.geometry.coordinates[1]+','+f.geometry.coordinates[0]).join('\n');return header+body;}
function fromGeoJSON(json){const gj=typeof json==='string'?JSON.parse(json):json;if(!gj||!Array.isArray(gj.features))return[];const feats=[];const seen=new Set();for(let i=0;i<gj.features.length;i++){const f=gj.features[i]||{};const p=f.properties||{};let code=p.POST_CODE||p.post_code||p.postcode||p.PostalCode||p.postalCode||p.code||p.tk;if(!code) continue;code=String(code).trim();if(!/^\d{4}$/.test(code)) continue;let coord=null;if(f.geometry&&f.geometry.type==='Point'){coord=f.geometry.coordinates;}else{try{coord=turf.centerOfMass(f).geometry.coordinates;}catch(e){try{coord=turf.center(f).geometry.coordinates;}catch(_){coord=null}}}if(coord&&Number.isFinite(coord[0])&&Number.isFinite(coord[1])){if(!seen.has(code)){feats.push({type:'Feature',properties:{postcode:code},geometry:{type:'Point',coordinates:[coord[0],coord[1]]}});seen.add(code);}}}return feats;}
function loadFeats(feats){tkLayer.clearLayers();tkLayer.addData(feats);tkIndex=new Map();tkLayer.eachLayer(l=>{const pc=String(l.feature.properties.postcode);const c=l.getLatLng();tkIndex.set(pc,L.latLng(c.lat,c.lng));});setLabels(labelsVisible);statusDiv.textContent='OK · ΤΚ: '+feats.length;updateSummary();try{localStorage.setItem('tk_cache_v1', toCSV(feats));}catch(_){} }
function nearestTK(latlng){let best=null,bestD=Infinity;tkLayer.eachLayer(l=>{const d=map.distance(latlng,l.getLatLng());if(d<bestD){bestD=d;best=l;}});return best?String(best.feature.properties.postcode):null;}
function updateSummary(){
  const pts=registry.map(r=>({id:r.id,lat:r.m.getLatLng().lat,lon:r.m.getLatLng().lng,name:r.name||('Marker #'+r.id)}));
  const assignByMarker=new Map();
  registry.forEach(r=>assignByMarker.set(r.id,[]));
  tkLayer.eachLayer(l=>{
    const pc=String(l.feature.properties.postcode);
    const c=l.getLatLng();
    let best={id:null,d:Infinity};
    for(let i=0;i<pts.length;i++){
      const p=pts[i];
      const d=Math.hypot(c.lat-p.lat,c.lng-p.lon);
      if(d<best.d){best={id:p.id,d}}}
    if(best.id!=null){assignByMarker.get(best.id).push(pc);} 
  });
  let totalAssigned=0;assignByMarker.forEach(v=>totalAssigned+=v.length);
  summaryDiv.textContent='Κατανεμημένοι: '+totalAssigned+' · Markers: '+registry.length;
  markersDiv.innerHTML='';
  for(let i=0;i<registry.length;i++){
    const r=registry[i];
    const here=nearestTK(r.m.getLatLng())||'—';
    const pcs=assignByMarker.get(r.id)||[];
    const card=document.createElement('div');
    card.innerHTML=
      '<div style="display:flex;justify-content:space-between;align-items:center;gap:8px">'
      +'<div style="display:flex;align-items:center;gap:6px">'
      +'<strong>#'+r.id+'</strong>'
      +'<input data-id="'+r.id+'" class="mname" value="'+(r.name||'')+'" placeholder="όνομα" style="width:160px;padding:6px;border:1px solid #e5e7eb;border-radius:8px" />'
      +'</div>'
      +'<div>'
      +'<button data-id="'+r.id+'" class="toggle">'+(r.labelShown?'Hide':'Show')+'</button>'
      +'<button data-id="'+r.id+'" class="rm">✖︎</button>'
      +'</div>'
      +'</div>'
      +'<div class="muted">'+r.m.getLatLng().lat.toFixed(5)+', '+r.m.getLatLng().lng.toFixed(5)+' · Κάτω από marker τώρα: '+here+'</div>'
      +'<div style="font-size:12px;margin-top:4px;max-height:200px;overflow:auto"><strong>ΤΚ ('+pcs.length+')</strong>: '+(pcs.length?pcs.join(', '):'—')+'</div>';
    markersDiv.appendChild(card);
  }
  Array.from(markersDiv.querySelectorAll('.rm')).forEach(btn=>btn.addEventListener('click',()=>{
    const id=+btn.getAttribute('data-id');
    const idx=registry.findIndex(x=>x.id===id);
    if(idx>-1){markersLayer.removeLayer(registry[idx].m);registry.splice(idx,1);updateSummary();}
  }));
  Array.from(markersDiv.querySelectorAll('.mname')).forEach(inp=>inp.addEventListener('input',()=>{
    const id=+inp.getAttribute('data-id');
    const r=registry.find(x=>x.id===id);
    if(r){r.name=inp.value; if(r.tooltip){r.tooltip.setContent(inp.value||('Marker #'+r.id));}}
    try{localStorage.setItem('markers_v1',JSON.stringify(registry.map(r=>({id:r.id,lat:r.m.getLatLng().lat,lon:r.m.getLatLng().lng,name:r.name||''}))))}catch(_){}}
  ));
  Array.from(markersDiv.querySelectorAll('.toggle')).forEach(btn=>btn.addEventListener('click',()=>{
    const id=+btn.getAttribute('data-id');
    const r=registry.find(x=>x.id===id);
    if(!r)return;
    r.labelShown=!r.labelShown;
    if(r.labelShown){ if(!r.tooltip){ r.tooltip=r.m.bindTooltip(r.name||('Marker #'+r.id),{permanent:true,offset:[0,-24],direction:'top'}).openTooltip(); } else { r.tooltip.setContent(r.name||('Marker #'+r.id)); r.tooltip.openTooltip(); } }
    else{ if(r.tooltip){ r.m.unbindTooltip(); r.tooltip=null; }
    }
    updateSummary();
  }));
  try{localStorage.setItem('markers_v1',JSON.stringify(registry.map(r=>({id:r.id,lat:r.m.getLatLng().lat,lon:r.m.getLatLng().lng,name:r.name||'',labelShown:!!r.labelShown}))))}catch(_){}}
function exportRows(){
  const rows=[]; if(!registry.length) return rows;
  const pts=registry.map(r=>({id:r.id,lat:r.m.getLatLng().lat,lon:r.m.getLatLng().lng,name:r.name||('Marker #'+r.id)}));
  tkLayer.eachLayer(l=>{
    const pc=String(l.feature.properties.postcode);
    const c=l.getLatLng();
    let best={id:null,d:Infinity};
    for(let i=0;i<pts.length;i++){
      const p=pts[i];
      const d=Math.hypot(c.lat-p.lat,c.lng-p.lon);
      if(d<best.d){best={id:p.id,d}}}
    if(best.id!=null){const m=pts.find(x=>x.id===best.id);rows.push({postcode:pc,marker_id:best.id,marker_name:m?m.name:('Marker #'+best.id)});}
  });
  return rows;
}
function downloadCSV(name,content){const blob=new Blob([content],{type:'text/csv;charset=utf-8;'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=name;a.click();}
function writeXLSX(name,rows){const wb=XLSX.utils.book_new();const ws=XLSX.utils.json_to_sheet(rows);XLSX.utils.book_append_sheet(wb,ws,'Assignments');XLSX.writeFile(wb,name);}
async function geocode(q){const u='https://nominatim.openstreetmap.org/search?format=jsonv2&countrycodes=cy&limit=5&q='+encodeURIComponent(q);try{const r=await fetch(u,{headers:{'Accept-Language':'el,en'}});if(!r.ok)throw 0;const arr=await r.json();return arr.map((o,i)=>({id:'a'+i,label:o.display_name,latlng:L.latLng(parseFloat(o.lat),parseFloat(o.lon)),zoom:16,marker:true}))}catch(e){return[]}}
function searchTK(q){const val=String(q).trim();const items=[];if(/^\d{4}$/.test(val)&&tkIndex.has(val)){items.push({id:'p-'+val,label:'ΤΚ '+val,latlng:tkIndex.get(val),zoom:15,marker:true})}tkIndex.forEach((v,k)=>{if(String(k).startsWith(val)&&String(k)!==val)items.push({id:'p-'+k,label:'ΤΚ '+k,latlng:v,zoom:15,marker:true})});return items.slice(0,10)}
function renderResults(items){if(!items.length){searchResults.innerHTML='<span class="muted">—</span>';return}let html='';for(let i=0;i<items.length;i++){const it=items[i];html+='<div class="item" data-id="'+it.id+'" style="cursor:pointer">'+it.label+'</div>'}searchResults.innerHTML=html;Array.from(searchResults.children).forEach(div=>div.addEventListener('click',()=>{const id=div.getAttribute('data-id');const it=items.find(x=>String(x.id)===String(id));if(!it)return;map.setView(it.latlng,it.zoom||15);if(it.marker){searchLayer.clearLayers();L.marker(it.latlng).addTo(searchLayer).bindPopup(it.label).openPopup()}}))}
async function handleSearch(){const q=searchInput.value.trim();if(!q){searchResults.innerHTML='';return}if(/^[0-9]{3,5}$/.test(q)){const items=searchTK(q);renderResults(items);if(items.length){map.setView(items[0].latlng,items[0].zoom||15);searchLayer.clearLayers();L.marker(items[0].latlng).addTo(searchLayer).bindPopup(items[0].label).openPopup()}return}const items=await geocode(q);renderResults(items);if(items.length){map.setView(items[0].latlng,items[0].zoom||16);searchLayer.clearLayers();L.marker(items[0].latlng).addTo(searchLayer).bindPopup(items[0].label).openPopup()}}
const OFFLINE_CSV='postcode,lat,lon\n1010,35.1700,33.3600\n1020,35.1700,33.3700\n1030,35.1500,33.3700\n1040,35.1560,33.3650\n1055,35.1700,33.3400\n1060,35.1800,33.3600\n1070,35.1700,33.3800\n1080,35.1900,33.3500';
function loadOffline(){const feats=fromCSV(OFFLINE_CSV);loadFeats(feats)}
addMarkerBtn.onclick=()=>{addMode=!addMode;addMarkerBtn.textContent=addMode?'Κλικ στον χάρτη':'Προσθήκη Marker'};
reassignBtn.onclick=()=>updateSummary();
exportCsvBtn.onclick=()=>{const rows=exportRows();if(!rows.length){alert('Βάλε marker.');return}const header='postcode,marker_id,marker_name\n';const body=rows.map(r=>r.postcode+','+r.marker_id+','+JSON.stringify(r.marker_name||'')).join('\n');downloadCSV('postcode_partition.csv',header+body)};
exportXlsxBtn.onclick=()=>{const rows=exportRows();if(!rows.length){alert('Βάλε marker.');return}writeXLSX('postcode_partition.xlsx',rows)};
toggleLabelsBtn.onclick=()=>{labelsVisible=!labelsVisible;setLabels(labelsVisible)};
map.on('click',e=>{if(!addMode)return;const m=L.marker(e.latlng,{draggable:true}).addTo(markersLayer);m.on('dragend',updateSummary);const entry={id:nextId++,m,name:'',labelShown:true,tooltip:null};entry.tooltip=m.bindTooltip('Marker #'+entry.id,{permanent:true,offset:[0,-24],direction:'top'}).openTooltip();registry.push(entry);addMode=false;addMarkerBtn.textContent='Προσθήκη Marker';updateSummary()});
importBtn.onclick=()=>fileInput.click();
clearCacheBtn.onclick=()=>{localStorage.removeItem('tk_cache_v1');statusDiv.textContent='Cache καθαρίστηκε'};
fileInput.onchange=()=>{const f=fileInput.files&&fileInput.files[0];if(!f)return;const reader=new FileReader();reader.onload=()=>{try{const text=String(reader.result);let feats=[];if(/\{\s*"type"\s*:\s*"FeatureCollection"/i.test(text)||/\.geojson$/i.test(f.name)||/\.json$/i.test(f.name)){feats=fromGeoJSON(text)}else{feats=fromCSV(text)}if(!feats.length)throw new Error('Άδειο/ασύμβατο αρχείο');loadFeats(feats);statusDiv.textContent='OK · Offline (εισαγωγή)'}catch(e){statusDiv.textContent='Σφάλμα εισαγωγής: '+(e&&e.message?e.message:'')}};reader.readAsText(f)};
searchBtn.onclick=()=>handleSearch();
clearSearchBtn.onclick=()=>{searchInput.value='';searchResults.innerHTML='';searchLayer.clearLayers()};
function parsePostcodeList(text){const found=String(text||'').match(/\b\d{4}\b/g)||[];const set=new Set(found);return Array.from(set).sort()}
async function geocodeOne(pc){const u='https://nominatim.openstreetmap.org/search?format=jsonv2&country=Cyprus&postalcode='+encodeURIComponent(pc)+'&limit=1';const r=await fetch(u,{headers:{'Accept-Language':'el,en'}});if(!r.ok)throw new Error('net');const arr=await r.json();if(!Array.isArray(arr)||!arr.length)throw new Error('notfound');const a=arr[0];const lat=parseFloat(a.lat),lon=parseFloat(a.lon);if(!Number.isFinite(lat)||!Number.isFinite(lon))throw new Error('coords');return {pc,lat,lon}}
async function geocodeList(postcodes){const feats=[];for(let i=0;i<postcodes.length;i++){const pc=postcodes[i];statusDiv.textContent='Γεωκωδικοποίηση '+pc+' ('+(i+1)+'/'+postcodes.length+')';try{const {lat,lon}=await geocodeOne(pc);feats.push({type:'Feature',properties:{postcode:String(pc)},geometry:{type:'Point',coordinates:[lon,lat]}})}catch(e){}await new Promise(res=>setTimeout(res,1100))}return feats}
pasteListBtn.onclick=()=>{pasteBox.style.display=pasteBox.style.display==='none'?'flex':'none'};
geocodeListBtn.onclick=async()=>{const list=parsePostcodeList(pasteArea.value);if(!list.length){alert('Δεν βρέθηκαν 4ψήφιοι ΤΚ στη λίστα.');return}geocodeListBtn.disabled=true;try{const feats=await geocodeList(list);if(!feats.length){statusDiv.textContent='Δεν βρέθηκαν συντεταγμένες για τη λίστα.'}else{loadFeats(feats);statusDiv.textContent='OK · Geocoded '+feats.length+' ΤΚ'}}finally{geocodeListBtn.disabled=false}};
function getAllFeats(){const feats=[];tkLayer.eachLayer(l=>{const pc=String(l.feature.properties.postcode);const c=l.getLatLng();feats.push({type:'Feature',properties:{postcode:pc},geometry:{type:'Point',coordinates:[c.lng,c.lat]}})});return feats}
function rebuildIndex(){tkIndex=new Map();tkLayer.eachLayer(l=>{const pc=String(l.feature.properties.postcode);const c=l.getLatLng();tkIndex.set(pc,L.latLng(c.lat,c.lng))})}
function upsertPostcode(pc,lat,lon){if(!/^\d{4}$/.test(String(pc)))throw new Error('Άκυρος ΤΚ');if(!Number.isFinite(lat)||!Number.isFinite(lon))throw new Error('Άκυρες συντεταγμένες');let target=null;tkLayer.eachLayer(l=>{if(!target&&String(l.feature.properties.postcode)===String(pc))target=l});if(target){target.setLatLng([lat,lon])}else{tkLayer.addData({type:'Feature',properties:{postcode:String(pc)},geometry:{type:'Point',coordinates:[lon,lat]}})}rebuildIndex();setLabels(labelsVisible);try{localStorage.setItem('tk_cache_v1', toCSV(getAllFeats()))}catch(_){}statusDiv.textContent='OK · ενημερώθηκε ο ΤΚ '+pc}
let qePickMode=false;const mapClickHandler=(e)=>{if(!qePickMode)return;qeLat.value=e.latlng.lat.toFixed(6);qeLon.value=e.latlng.lng.toFixed(6);qePickMode=false;statusDiv.textContent='Έτοιμο: συμπληρώθηκαν lat/lon από χάρτη'};
qePick.onclick=()=>{qePickMode=!qePickMode;statusDiv.textContent=qePickMode?'Κάνε κλικ στον χάρτη για lat/lon…':'Pick ακυρώθηκε'};
qeApply.onclick=()=>{const pc=qePostcode.value.trim();const lat=parseFloat(qeLat.value);const lon=parseFloat(qeLon.value);try{upsertPostcode(pc,lat,lon)}catch(e){alert(e.message||'Σφάλμα');return}};
map.on('click',mapClickHandler);
function downloadJSON(name,obj){const blob=new Blob([JSON.stringify(obj)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=name;a.click()}
saveStateBtn.onclick=()=>{const state={version:'v2.15.1',labelsVisible,tk_csv:toCSV(getAllFeats()),markers:registry.map(r=>({id:r.id,lat:r.m.getLatLng().lat,lon:r.m.getLatLng().lng,name:r.name||'',labelShown:!!r.labelShown}))};downloadJSON('tk_state.json',state);statusDiv.textContent='Αποθηκεύτηκε η κατάσταση (json)'};
loadStateBtn.onclick=async()=>{try{const r=await fetch('./state.json',{cache:'no-store'});if(r.ok){const st=await r.json();await loadStateObject(st);return}}catch(_){const x=0}
const inp=document.createElement('input');inp.type='file';inp.accept='.json';inp.onchange=()=>{const f=inp.files&&inp.files[0];if(!f)return;const reader=new FileReader();reader.onload=async()=>{try{const st=JSON.parse(String(reader.result));await loadStateObject(st)}catch(e){alert('Κατεστραμμένο JSON')}};reader.readAsText(f)};inp.click()};
async function loadStateObject(st){if(!st||!st.tk_csv)throw new Error('missing tk_csv');const feats=fromCSV(st.tk_csv);loadFeats(feats);labelsVisible=!!st.labelsVisible;setLabels(labelsVisible);markersLayer.clearLayers();registry=[];nextId=1;(st.markers||[]).forEach(m=>{const mark=L.marker([m.lat,m.lon],{draggable:true}).addTo(markersLayer);mark.on('dragend',updateSummary);const entry={id:nextId++,m:mark,name:m.name||'',labelShown:!!m.labelShown,tooltip:null};if(entry.labelShown){entry.tooltip=mark.bindTooltip(entry.name||('Marker #'+entry.id),{permanent:true,offset:[0,-24],direction:'top'}).openTooltip()}registry.push(entry)});updateSummary();statusDiv.textContent='OK · Φορτώθηκε κατάσταση'}
function b64(str){return btoa(unescape(encodeURIComponent(str)))}
function saveGhSettings(){try{localStorage.setItem('gh_cfg',JSON.stringify({o:ghOwner.value||'',r:ghRepo.value||'',b:ghBranch.value||'main',p:ghPath.value||'state.json'}))}catch(_){} }
function loadGhSettings(){try{const v=JSON.parse(localStorage.getItem('gh_cfg')||'null');if(v){ghOwner.value=v.o||'';ghRepo.value=v.r||'';ghBranch.value=v.b||'main';ghPath.value=v.p||'state.json'}}catch(_){} }
async function ghGet(o,r,p,b){const u=`https://api.github.com/repos/${encodeURIComponent(o)}/${encodeURIComponent(r)}/contents/${p}?ref=${encodeURIComponent(b||'main')}`;const res=await fetch(u,{headers:{'Accept':'application/vnd.github+json'}});if(res.status===404)return null; if(!res.ok)throw new Error('GH get failed');return res.json()}
async function ghPut(o,r,p,b,token,content,msg,sha){const u=`https://api.github.com/repos/${encodeURIComponent(o)}/${encodeURIComponent(r)}/contents/${p}`;const body={message:msg||'Update state.json',content:b64(content),branch:b||'main'};if(sha)body.sha=sha;const res=await fetch(u,{method:'PUT',headers:{'Accept':'application/vnd.github+json','Authorization':`Bearer ${token}`},body:JSON.stringify(body)});if(!res.ok)throw new Error('GH put failed');return res.json()}
function currentStateString(){const state={version:'v2.15.1',labelsVisible,tk_csv:toCSV(getAllFeats()),markers:registry.map(r=>({id:r.id,lat:r.m.getLatLng().lat,lon:r.m.getLatLng().lng,name:r.name||'',labelShown:!!r.labelShown}))};return JSON.stringify(state)}

ghSaveBtn.onclick=async()=>{const o=ghOwner.value.trim(),r=ghRepo.value.trim(),b=(ghBranch.value.trim()||'main'),p=(ghPath.value.trim()||'state.json'),t=ghToken.value.trim();if(!o||!r||!t){alert('Συμπλήρωσε owner, repo, token.');return}saveGhSettings();statusDiv.textContent='GitHub: αποθήκευση…';try{let sha=null;const meta=await ghGet(o,r,p,b);if(meta&&meta.sha)sha=meta.sha;const payload=currentStateString();await ghPut(o,r,p,b,t,payload,'TK Finder: save state',sha);statusDiv.textContent='OK · Αποθηκεύτηκε στο GitHub ('+o+'/'+r+':'+p+')'}catch(e){statusDiv.textContent='Σφάλμα GitHub save'} };

ghLoadBtn.onclick=async()=>{const o=ghOwner.value.trim(),r=ghRepo.value.trim(),b=(ghBranch.value.trim()||'main'),p=(ghPath.value.trim()||'state.json');if(!o||!r){alert('Συμπλήρωσε owner, repo.');return}saveGhSettings();statusDiv.textContent='GitHub: φόρτωση…';try{const meta=await ghGet(o,r,p,b);if(!meta||!meta.download_url)throw new Error('not found');const r2=await fetch(meta.download_url,{cache:'no-store'});const st=await r2.json();await loadStateObject(st);statusDiv.textContent='OK · Φορτώθηκε από GitHub'}catch(e){statusDiv.textContent='Σφάλμα GitHub load'}}

loadGhSettings();
(async function init(){try{const r=await fetch('./state.json',{cache:'no-store'});if(r.ok){const st=await r.json();await loadStateObject(st);return}}catch(_){const x=0}
const cached=localStorage.getItem('tk_cache_v1');if(cached){try{const feats=fromCSV(cached);if(feats.length){loadFeats(feats);statusDiv.textContent='OK · Cache'}else{throw 0}}catch(_){statusDiv.textContent='Offline μέχρι να γίνει εισαγωγή ή γεωκωδικοποίηση.';loadOffline()}}else{statusDiv.textContent='Offline μέχρι να γίνει εισαγωγή ή γεωκωδικοποίηση.';loadOffline()}
try{const saved=JSON.parse(localStorage.getItem('markers_v1')||'[]');if(Array.isArray(saved)&&saved.length){registry=[];nextId=1;saved.forEach(m=>{const mark=L.marker([m.lat,m.lon],{draggable:true}).addTo(markersLayer);mark.on('dragend',updateSummary);const entry={id:nextId++,m:mark,name:m.name||'',labelShown:!!m.labelShown,tooltip:null};if(entry.labelShown){entry.tooltip=mark.bindTooltip(entry.name||('Marker #'+entry.id),{permanent:true,offset:[0,-24],direction:'top'}).openTooltip()}registry.push(entry)});updateSummary()}}catch(_){const x=0}}
)();
(function runTests(){try{console.assert(fromCSV('postcode,lat,lon\n1234,35.1,33.1').length===1,'CSV basic');const feats=[{type:'Feature',properties:{postcode:'1234'},geometry:{type:'Point',coordinates:[33.1,35.1]}}];const csv=toCSV(feats);console.assert(/1234,35\.1,33\.1/.test(csv),'toCSV');const gj={type:'FeatureCollection',features:[{type:'Feature',properties:{POST_CODE:1234},geometry:{type:'Polygon',coordinates:[[[33,35],[33.2,35],[33.2,35.2],[33,35.2],[33,35]]]}}]};console.assert(fromGeoJSON(gj).length===1,'GeoJSON centroid');const gj2={type:'FeatureCollection',features:[{type:'Feature',properties:{postcode:'5678'},geometry:{type:'Point',coordinates:[33.4,35.2]}}]};console.assert(fromGeoJSON(gj2).length===1,'GeoJSON point passthrough')}catch(e){}}
)();
</script>
</body>
</html>
