<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ÎšÏÏ€ÏÎ¿Ï‚ â€“ Î¤Î±Ï‡Ï…Î´ÏÎ¿Î¼Î¹ÎºÎ¿Î¯ ÎšÏÎ´Î¹ÎºÎµÏ‚ (TK) | Finder (Overpass Online)</title>
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- Turf.js Î³Î¹Î± Î³ÎµÏ‰Ï‡Ï‰ÏÎ¹ÎºÎ¿ÏÏ‚ Ï…Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼Î¿ÏÏ‚ -->
  <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
  <!-- SheetJS Î³Î¹Î± ÎµÎ¾Î±Î³Ï‰Î³Î® ÏƒÎµ Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    html, body { height: 100%; margin: 0; }
    body { display: grid; grid-template-columns: 1fr 420px; height: 100%; }
    #map { position: relative; height: 100vh; min-height: 320px; }
    #panel { border-left: 1px solid #e5e7eb; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; overflow: auto; }
    .panel-header { padding: 12px 16px; border-bottom: 1px solid #e5e7eb; }
    .panel-header h1 { margin: 0; font-size: 16px; }
    .panel-body { padding: 12px 16px; }
    .badge { display:inline-block; padding: 2px 8px; border-radius: 9999px; background:#eef2ff; color:#3730a3; font-weight:600; font-size:12px; }
    .small { color:#475569; font-size:12px; }
    .btn { display:inline-block; padding:8px 10px; border-radius:10px; background:#111827; color:#fff; border:0; cursor:pointer; font-weight:600; }
    .btn.secondary{ background:#e5e7eb; color:#111827; }
    .btn.warn{ background:#dc2626; }
    .btn+.btn { margin-left: 8px; }
    .item { border-top:1px dashed #e5e7eb; padding:8px 0; }
    .muted{ color:#6b7280; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .pill { padding:2px 6px; border-radius:999px; background:#f1f5f9; }
    .foot { border-top:1px solid #e5e7eb; padding:10px 16px; font-size:12px; color:#64748b; }
    .assign { font-size:12px; color:#334155; }
    progress { width: 100%; height: 10px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>
<body>
  <div id="map"></div>
  <aside id="panel">
    <div class="panel-header">
      <h1>ÎšÏÏ€ÏÎ¿Ï‚ â€“ TK Finder <span class="badge">Overpass</span></h1>
      <div class="small">Î’Î¬Î»Îµ markers ÏƒÏ„Î¿Î½ Ï‡Î¬ÏÏ„Î·. ÎŒÎ»Î¿Î¹ Î¿Î¹ Î¤Îš Î¸Î± <strong>Î¼Î¿Î¹ÏÎ±ÏƒÏ„Î¿ÏÎ½</strong> Î¼Î¿Î½Î±Î´Î¹ÎºÎ¬ ÏƒÏ„Î¿Ï…Ï‚ markers Î¼Îµ Î²Î¬ÏƒÎ· Ï„Î·Î½ <em>ÎµÏ…Î¸ÎµÎ¯Î± Î±Ï€ÏŒÏƒÏ„Î±ÏƒÎ·</em>. Î¤Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î± Î¤Îš Ï†Î¿ÏÏ„ÏÎ½Î¿Î½Ï„Î±Î¹ online Î±Ï€ÏŒ Overpass (OSM) Î¼Îµ fallback ÏƒÎµ Nominatim ÎºÎ±Î¹ Î±Ï€Î¿Î¸Î·ÎºÎµÏÎ¿Î½Ï„Î±Î¹ ÏƒÎµ <span class="mono">localStorage</span>.</div>
    </div>
    <div class="panel-body">
      <div class="row" style="margin-bottom:8px;">
        <button class="btn" id="addMarkerBtn">â• Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Marker</button>
        <button class="btn secondary" id="reassignBtn">ğŸ”„ Î‘Î½Î±ÎºÎ±Ï„Î±Î½Î¿Î¼Î® Î¤Îš</button>
        <button class="btn secondary" id="exportBtn">â¬‡ï¸ Î•Î¾Î±Î³Ï‰Î³Î® CSV</button>
        <button class="btn secondary" id="exportExcelBtn">ğŸ“Š Î•Î¾Î±Î³Ï‰Î³Î® Excel</button>
        <button class="btn secondary" id="clearBtn">ğŸ§¹ ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚</button>
      </div>
      <div class="small muted" style="margin-bottom:12px;">Î Î·Î³Î® ÏƒÏ…Î½Ï„ÎµÏ„Î±Î³Î¼Î­Î½Ï‰Î½: Overpass (addr:postcode) Î¼Îµ fallback ÏƒÎµ Nominatim Î³Î¹Î± ÎµÎ»Î»ÎµÎ¯Ï€Î¿Î½Ï„ÎµÏ‚ Î¤Îš. Cache ÏƒÎµ <span class="mono">tk_coords_v1</span>.</div>
      <div id="status" class="small loading">Î•ÎºÎºÎ¯Î½Î·ÏƒÎ·â€¦</div>
      <div class="row" style="margin:8px 0;">
        <button class="btn secondary" id="startGeoBtn">ğŸ§­ Build Î£Ï…Î½Ï„ÎµÏ„Î±Î³Î¼Î­Î½ÎµÏ‚</button>
        <button class="btn secondary" id="stopGeoBtn" disabled>â¸ï¸ Î”Î¹Î±ÎºÎ¿Ï€Î®</button>
        <button class="btn secondary" id="clearCacheBtn">ğŸ—‘ï¸ ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚ Cache</button>
      </div>
      <div class="small"><progress id="geoProgress" max="100" value="0"></progress> <span id="geoCounts" class="small muted"></span></div>
      <div class="row" style="margin:10px 0;">
        <input id="searchInput" placeholder="Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ· Î¤Îš (Ï€.Ï‡. 1010)" class="mono" style="flex:1; padding:8px 10px; border:1px solid #e5e7eb; border-radius:10px;" />
        <button class="btn secondary" id="searchBtn">ğŸ” ÎœÎµÏ„Î¬Î²Î±ÏƒÎ·</button>
      </div>
      <div id="current"></div>
      <h3 style="margin-top:16px;">Markers</h3>
      <div id="markers"></div>
      <h3 style="margin-top:16px;">Î£ÏÎ½Î¿ÏˆÎ· ÎšÎ±Ï„Î±Î½Î¿Î¼Î®Ï‚ Î¤Îš</h3>
      <div id="assignment"></div>
      <h3 style="margin-top:16px;">Tests</h3>
      <div id="tests" class="small"></div>
    </div>
    <div class="foot">OpenStreetMap Overpass/Nominatim Â· Î§ÏÎ®ÏƒÎ· Î¼ÏŒÎ½Î¿ Î³Î¹Î± Î´Î¿ÎºÎ¹Î¼Î®/ÎµÎºÏ€Î±Î¯Î´ÎµÏ…ÏƒÎ·.</div>
  </aside>

<script>
// ------------------ Î’Î‘Î£Î™ÎšÎŸÎ£ Î§Î‘Î¡Î¤Î—Î£ ------------------
const map = L.map('map', { preferCanvas: true }).setView([35.1264, 33.4299], 9);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap' }).addTo(map);
window.addEventListener('load', ()=> setTimeout(()=> map.invalidateSize(), 200));
window.addEventListener('resize', ()=> map.invalidateSize());

// Layers
const tkCentroidsLayer = L.geoJSON(null, {
  pointToLayer: (feat, latlng) => L.circleMarker(latlng, { radius: 3.5, weight: 1, fillOpacity: .7, color: '#2563eb', fillColor: '#3b82f6' })
    .bindTooltip("Î¤Îš: " + feat.properties.postcode, { permanent: false, direction: 'top' })
}).addTo(map);
const markersLayer = L.layerGroup().addTo(map);
const highlightLayer = L.layerGroup().addTo(map);

let addMarkerMode = false;
let markersRegistry = [];
let nextMarkerId = 1;

// UI refs
const addMarkerBtn = document.getElementById('addMarkerBtn');
const clearBtn = document.getElementById('clearBtn');
const exportBtn = document.getElementById('exportBtn');
const exportExcelBtn = document.getElementById('exportExcelBtn');
const reassignBtn = document.getElementById('reassignBtn');
const startGeoBtn = document.getElementById('startGeoBtn');
const stopGeoBtn = document.getElementById('stopGeoBtn');
const clearCacheBtn = document.getElementById('clearCacheBtn');
const statusDiv = document.getElementById('status');
const markersDiv = document.getElementById('markers');
const assignmentDiv = document.getElementById('assignment');
const testsDiv = document.getElementById('tests');
const searchInput = document.getElementById('searchInput');
const searchBtn = document.getElementById('searchBtn');
const geoProgress = document.getElementById('geoProgress');
const geoCounts = document.getElementById('geoCounts');

addMarkerBtn.onclick = ()=>{ addMarkerMode = !addMarkerMode; addMarkerBtn.textContent = addMarkerMode ? 'âœ… ÎšÎ»Î¹Îº ÏƒÏ„Î¿Î½ Ï‡Î¬ÏÏ„Î·' : 'â• Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Marker'; };
clearBtn.onclick = ()=>{ markersLayer.clearLayers(); highlightLayer.clearLayers(); markersDiv.innerHTML=''; assignmentDiv.innerHTML=''; markersRegistry=[]; };
</script>
</body>
</html>
