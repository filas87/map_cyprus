<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Κύπρος – Ταχυδρομικοί Κώδικες (TK) | Finder (Offline + Cache)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    html, body { height: 100%; margin: 0; }
    body { display: grid; grid-template-columns: 1fr 420px; height: 100%; }
    #map { position: relative; height: 100vh; min-height: 320px; }
    #panel { border-left: 1px solid #e5e7eb; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; overflow: auto; }
    .panel-header { padding: 12px 16px; border-bottom: 1px solid #e5e7eb; }
    .panel-header h1 { margin: 0; font-size: 16px; }
    .panel-body { padding: 12px 16px; }
    .badge { display:inline-block; padding: 2px 8px; border-radius: 9999px; background:#eef2ff; color:#3730a3; font-weight:600; font-size:12px; }
    .small { color:#475569; font-size:12px; }
    .btn { display:inline-block; padding:8px 10px; border-radius:10px; background:#111827; color:#fff; border:0; cursor:pointer; font-weight:600; }
    .btn.secondary{ background:#e5e7eb; color:#111827; }
    .btn.warn{ background:#dc2626; }
    .btn+.btn { margin-left: 8px; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .item { border-top:1px dashed #e5e7eb; padding:8px 0; }
    .assign { font-size:12px; color:#334155; }
    .tk-list { max-height:150px; overflow:auto; font-size:11px; color:#475569; margin-top:4px; border:1px solid #e5e7eb; padding:4px; border-radius:6px; background:#f9fafb; }
    .foot { border-top:1px solid #e5e7eb; padding:10px 16px; font-size:12px; color:#64748b; }
    progress { width: 100%; height: 10px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .muted { color:#6b7280; }
  </style>
</head>
<body>
  <div id="map"></div>
  <aside id="panel">
    <div class="panel-header">
      <h1>Κύπρος – TK Finder <span class="badge">Offline+Cache</span> <span class="badge" style="background:#d1fae5;color:#065f46;">v1.2</span></h1>
      <div class="small">ΤΚ από ενσωματωμένο CSV ή από Overpass με αποθήκευση σε cache για offline χρήση.</div>
    </div>
    <div class="panel-body">
      <div class="row" style="margin-bottom:8px;">
        <button class="btn" id="addMarkerBtn">➕ Προσθήκη Marker</button>
        <button class="btn secondary" id="reassignBtn">🔄 Ανακατανομή</button>
        <button class="btn secondary" id="exportBtn">⬇️ Εξαγωγή CSV</button>
        <button class="btn secondary" id="exportExcelBtn">📊 Εξαγωγή Excel</button>
        <button class="btn secondary" id="clearBtn">🧹 Καθαρισμός</button>
      </div>
      <div class="row" style="margin-bottom:8px;">
        <button class="btn" id="fetchAllBtn">🧭 Λήψη όλων (Overpass) & Αποθήκευση</button>
        <button class="btn secondary" id="clearCacheBtn">🗑️ Καθαρισμός Cache</button>
      </div>
      <div id="status" class="small loading">Εκκίνηση...</div>
      <div class="row" style="margin:10px 0;">
        <input id="searchInput" placeholder="Αναζήτηση ΤΚ (π.χ. 1010)" class="mono" style="flex:1; padding:8px 10px; border:1px solid #e5e7eb; border-radius:10px;" />
        <button class="btn secondary" id="searchBtn">🔎 Μετάβαση</button>
      </div>
      <h3 style="margin-top:12px;">Markers</h3>
      <div id="markers"></div>
      <h3 style="margin-top:12px;">Σύνοψη Κατανομής ΤΚ</h3>
      <div id="assignment" class="small"></div>
      <h3 style="margin-top:12px;">Tests</h3>
      <div id="tests" class="small muted"></div>
    </div>
    <div class="foot">Offline CSV + Overpass cache</div>
  </aside>

<script>
// ===== Χάρτης =====
const map = L.map('map', { preferCanvas:true }).setView([35.1264, 33.4299], 9);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap' }).addTo(map);
window.addEventListener('load', ()=> setTimeout(()=> map.invalidateSize(), 150));
window.addEventListener('resize', ()=> map.invalidateSize());

// Layers
const tkCentroidsLayer = L.geoJSON(null, {
  pointToLayer: (feat, latlng) => L.circleMarker(latlng, { radius: 3, color: '#2563eb', fillColor: '#3b82f6', fillOpacity: 0.85 })
    .bindTooltip('ΤΚ: '+(feat.properties && feat.properties.postcode || ''), { permanent:true, direction:'right', offset:[8,0] })
}).addTo(map);
const markersLayer = L.layerGroup().addTo(map);
const highlightLayer = L.layerGroup().addTo(map);

// ===== State =====
let tkCentroids = [];
let tkIndex = new Map();
let addMarkerMode = false;
let nextMarkerId = 1;
const markersRegistry = [];
// Μόνο 4-ψήφιοι ΤΚ (Ελεύθερη Κύπρος)
const isFreeCYPostcode = (code)=>{ const s=String(code||'').trim(); if(s.length!==4) return false; for(let i=0;i<4;i++){ const c=s.charCodeAt(i); if(c<48||c>57) return false; } return true; };

// ===== UI refs =====
const addMarkerBtn = document.getElementById('addMarkerBtn');
const reassignBtn = document.getElementById('reassignBtn');
const exportBtn = document.getElementById('exportBtn');
const exportExcelBtn = document.getElementById('exportExcelBtn');
const clearBtn = document.getElementById('clearBtn');
const statusDiv = document.getElementById('status');
const searchInput = document.getElementById('searchInput');
const searchBtn = document.getElementById('searchBtn');
const markersDiv = document.getElementById('markers');
const assignmentDiv = document.getElementById('assignment');
const testsDiv = document.getElementById('tests');
const fetchAllBtn = document.getElementById('fetchAllBtn');
const clearCacheBtn = document.getElementById('clearCacheBtn');

// ===== Markers =====
addMarkerBtn.onclick = ()=>{ addMarkerMode = !addMarkerMode; addMarkerBtn.textContent = addMarkerMode ? '✅ Κλικ στον χάρτη' : '➕ Προσθήκη Marker'; };
reassignBtn.onclick = ()=> recomputeAssignments();
clearBtn.onclick = ()=>{ markersLayer.clearLayers(); highlightLayer.clearLayers(); markersRegistry.splice(0); markersDiv.innerHTML=''; assignmentDiv.innerHTML=''; };
map.on('click', e=>{ if(!addMarkerMode) return; addMarker(e.latlng); addMarkerMode=false; addMarkerBtn.textContent='➕ Προσθήκη Marker'; });

function addMarker(latlng){
  const id = nextMarkerId++;
  const m = L.marker(latlng,{draggable:true}).addTo(markersLayer);
  m.on('dragend', ()=>{ updateMarkerCard(id); recomputeAssignments(); const ent=markersRegistry.find(x=>x.id===id); if(ent && ent.label) ent.label.setLatLng(m.getLatLng()); });
  markersRegistry.push({id, marker:m, note:'', label:null});
  renderMarkerCard(id);
  attachNoteHandler(id);
  updateMarkerCard(id);
  m.bindPopup(`Marker #${id}`);
  recomputeAssignments();
}
function renderMarkerCard(id){
  const wrap=document.createElement('div'); wrap.className='item'; wrap.id=`marker-card-${id}`;
  wrap.innerHTML = `
    <div class="row" style="justify-content:space-between;align-items:center;">
      <div><strong>Marker #${id}</strong> <span class="assign" id="assign-count-${id}"></span> <span class="small muted" id="marker-note-preview-${id}"></span></div>
      <div>
        <button class="btn secondary" onclick="zoomToMarker(${id})">🔎 Zoom</button>
        <button class="btn warn" onclick="removeMarker(${id})">✖︎</button>
      </div>
    </div>
    <div id="marker-pos-${id}" class="small" style="color:#6b7280;"></div>
    <input id="marker-note-${id}" class="mono" placeholder="Σημείωση/Όνομα (π.χ. Ομάδα Α)" style="width:100%; padding:6px 8px; border:1px solid #e5e7eb; border-radius:8px; margin:6px 0;" />
    <div id="marker-tklist-${id}" class="tk-list"></div>
  `;
  markersDiv.prepend(wrap);
}
function updateMarkerCard(id){
  const entry = markersRegistry.find(x=>x.id===id); if(!entry) return; const ll = entry.marker.getLatLng();
  const el = document.getElementById(`marker-pos-${id}`); if(el) el.textContent = `${ll.lat.toFixed(5)}, ${ll.lng.toFixed(5)}`;
}
window.zoomToMarker = function(id){ const ent=markersRegistry.find(x=>x.id===id); if(ent) map.panTo(ent.marker.getLatLng()); };
function attachNoteHandler(id){
  const entry = markersRegistry.find(x=>x.id===id); if(!entry) return;
  const input = document.getElementById(`marker-note-${id}`);
  const preview = document.getElementById(`marker-note-preview-${id}`);
  if(!input) return;
  input.value = entry.note || '';
  const apply = ()=>{
    entry.note = input.value.trim();
    if(preview) preview.textContent = entry.note ? `· ${entry.note}` : '';
    try{ entry.marker.unbindTooltip(); }catch{}
    if(entry.label) { map.removeLayer(entry.label); entry.label=null; }
    if(entry.note){
      entry.label = L.tooltip({permanent:true, direction:'top', offset:[0,-20]}).setContent(entry.note).setLatLng(entry.marker.getLatLng());
      entry.label.addTo(map);
    }
  };
  input.addEventListener('input', apply);
  apply();
}

window.removeMarker = function(id){
  const idx=markersRegistry.findIndex(x=>x.id===id); if(idx<0) return; 
  const ent=markersRegistry[idx];
  if(ent.label) map.removeLayer(ent.label);
  markersLayer.removeLayer(ent.marker);
  markersRegistry.splice(idx,1);
  const card=document.getElementById(`marker-card-${id}`); if(card) card.remove(); recomputeAssignments();
};

// ===== Toggle TK labels =====
let tkLabelsVisible=true;
function updateTkLabels(){
  if(tkLabelsVisible){
    tkCentroidsLayer.eachLayer(l=> l.openTooltip());
  } else {
    tkCentroidsLayer.eachLayer(l=> l.closeTooltip());
  }
}

// Add toggle button
const toggleTkBtn=document.createElement('button');
 toggleTkBtn.className='btn secondary';
 toggleTkBtn.textContent='👁️ Εναλλαγή ΤΚ Labels';
 toggleTkBtn.onclick=()=>{ tkLabelsVisible=!tkLabelsVisible; updateTkLabels(); };
 document.querySelector('.panel-body').prepend(toggleTkBtn);

// ===== Offline CSV Data (ενσωματωμένο ή από cache) =====
let csvData = (localStorage.getItem('tk_offline_csv') || `postcode,lat,lon\n1010,35.1667,33.3667\n1020,35.1700,33.3700\n1030,35.1500,33.3700\n2000,34.6750,33.0333\n2100,35.1000,33.4167\n2200,35.0417,33.5000\n2410,35.1667,33.3667\n3100,34.6833,33.0333\n4000,34.9167,33.6333\n6015,34.9167,33.6333\n8500,34.7667,32.4167`);

function parseCSV(txt){
  const lines=txt.split(/\r?\n/).filter(Boolean);
  const header=lines.shift().split(',').map(h=>h.trim());
  const idxPost=header.indexOf('postcode');
  const idxLat=header.indexOf('lat');
  const idxLon=header.indexOf('lon');
  if(idxPost<0||idxLat<0||idxLon<0) throw new Error('CSV must have postcode, lat, lon');
  const feats=[];
  for(const line of lines){
    const parts=line.split(',');
    const pc=parts[idxPost]; const lat=parseFloat(parts[idxLat]); const lon=parseFloat(parts[idxLon]);
    if(!pc||isNaN(lat)||isNaN(lon)) continue;
    if(!isFreeCYPostcode(pc)) continue;
    feats.push({type:'Feature',properties:{postcode:pc},geometry:{type:'Point',coordinates:[lon,lat]}});
  }
  return feats;
}

function loadFromCSVString(csv){
  try{
    const feats=parseCSV(csv);
    tkCentroidsLayer.clearLayers(); tkCentroidsLayer.addData(feats);
    tkCentroids=feats.slice();
    tkIndex=new Map(feats.map(f=>[f.properties.postcode, f.geometry.coordinates]));
    statusDiv.textContent=`OK ✔︎ Φορτώθηκαν ${feats.length} ΤΚ (CSV, 4-ψηφ.).`;;
    updateTkLabels();
    recomputeAssignments();
  }catch(err){
    console.error('CSV load error', err);
    statusDiv.textContent='Σφάλμα φόρτωσης CSV: '+err.message;
  }
}

function loadOfflinePostcodes(){ loadFromCSVString(csvData); }
loadOfflinePostcodes();

// ===== Search bar =====
searchBtn.onclick = ()=> handleSearch();
searchInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter') handleSearch(); });
async function handleSearch(){
  const code=(searchInput.value||'').trim().replace(/\s+/g,''); if(!code) return;
  let coord=tkIndex.get(code);
  if(!coord){ alert('Δεν βρέθηκε ο ΤΚ '+code); return; }
  const latlng=[coord[1],coord[0]]; map.setView(latlng, Math.max(13,map.getZoom()), {animate:true});
  flashHighlight(latlng, code);
}
function flashHighlight(latlng, code){
  try{ highlightLayer.clearLayers(); }catch{}
  L.circle(latlng, { radius:500, weight:2, color:'#2563eb', fillOpacity:0.12 }).addTo(highlightLayer);
  L.circleMarker(latlng, { radius:7, weight:2 }).addTo(highlightLayer).bindTooltip('ΤΚ '+code);
  setTimeout(()=>{ try{highlightLayer.clearLayers();}catch{} }, 4500);
}

// ===== Κατανομή =====
function recomputeAssignments(){
  assignmentDiv.innerHTML='';
  if(markersRegistry.length===0 || tkCentroids.length===0) return;
  const markerPts=markersRegistry.map(r=>({id:r.id,pt:turf.point([r.marker.getLatLng().lng,r.marker.getLatLng().lat])}));
  const assign=new Map(); markersRegistry.forEach(r=>assign.set(r.id,{codes:[],total:0}));
  for(const f of tkCentroids){
    let bestId=null, bestD=Infinity; const tkpt=f;
    for(const m of markerPts){ const d=turf.distance(m.pt, tkpt,{units:'kilometers'}); if(d<bestD-1e-9){ bestD=d; bestId=m.id; } }
    if(bestId!=null){ const slot=assign.get(bestId); slot.codes.push(f.properties.postcode); slot.total++; }
  }
  let total=0; for(const [id,slot] of assign.entries()){
    total+=slot.total; const el=document.getElementById(`assign-count-${id}`); if(el) el.textContent=`· ${slot.total} ΤΚ`;
    const listEl=document.getElementById(`marker-tklist-${id}`);
    if(listEl) listEl.innerHTML=slot.codes.sort((a,b)=>a.localeCompare(b)).join(', ');
  }
  assignmentDiv.textContent=`Σύνολο ΤΚ: ${tkCentroids.length} · Κατανεμημένοι: ${total} · Markers: ${markersRegistry.length}`;
}

// Update marker labels position on drag (extra safety)
markersLayer.on('layeradd', (e)=>{
  if(e.layer && e.layer.on){
    e.layer.on('drag', ()=>{
      const ent = markersRegistry.find(x=>x.marker===e.layer);
      if(ent && ent.label){ ent.label.setLatLng(e.layer.getLatLng()); }
    });
  }
});

// ===== Exports =====
function computeAssignmentRows(){
  const rows=[]; if(markersRegistry.length===0) return rows;
  const markerPts=markersRegistry.map(r=>({id:r.id,pt:turf.point([r.marker.getLatLng().lng,r.marker.getLatLng().lat])}));
  for(const f of tkCentroids){
    let best={id:null,km:Infinity};
    for(const m of markerPts){ const km=turf.distance(m.pt,f,{units:'kilometers'}); if(km<best.km-1e-9){ best={id:m.id,km}; } }
    if(best.id!=null){
      const note = (markersRegistry.find(x=>x.id===best.id)?.note)||'';
      rows.push({postcode:f.properties.postcode,marker_id:best.id,marker_note:note,distance_km:+best.km.toFixed(4)});
    }
  }
  return rows;
}
exportBtn.onclick=()=>{
  const rows=computeAssignmentRows(); if(!rows.length){ alert('Βάλε τουλάχιστον 1 marker.'); return; }
  const header='postcode,marker_id,marker_note,distance_km\n';
  const body=rows.map(r=>`${r.postcode},${r.marker_id},"${(r.marker_note||'').replace(/"/g,'""')}",${r.distance_km}`).join('\n');
  const blob=new Blob([header+body],{type:'text/csv;charset=utf-8;'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='postcode_partition.csv'; a.click();
};
exportExcelBtn.onclick=()=>{
  const rows=computeAssignmentRows(); if(!rows.length){ alert('Βάλε τουλάχιστον 1 marker.'); return; }
  const wb=XLSX.utils.book_new(); const ws=XLSX.utils.json_to_sheet(rows); XLSX.utils.book_append_sheet(wb,ws,'Assignments'); XLSX.writeFile(wb,'postcode_partition.xlsx');
};

// ===== Overpass fetch-all & cache =====
const OVERPASS = [
  'https://overpass-api.de/api/interpreter',
  'https://lz4.overpass-api.de/api/interpreter',
  'https://z.overpass-api.de/api/interpreter',
  'https://overpass.kumi.systems/api/interpreter'
];
const OP_QUERY = `
[out:json][timeout:180];
area["ISO3166-1"="CY"][admin_level=2]->.a;
(
  node(area.a)["addr:postcode"];
  way(area.a)["addr:postcode"];
  relation(area.a)["addr:postcode"];
  relation(area.a)["postal_code"];
  relation(area.a)["boundary"="postal_code"];
);
out center tags;
`;
async function fetchOverpassWithRetry(){
  let lastErr=null;
  for(let i=0;i<OVERPASS.length;i++){
    const base=OVERPASS[i]; statusDiv.textContent=`Σύνδεση Overpass ${i+1}/${OVERPASS.length}…`;
    try{
      const getUrl = base + '?data=' + encodeURIComponent(OP_QUERY);
      const resG = await fetch(getUrl, { method:'GET' });
      if(resG.ok){ return await resG.json(); }
      lastErr = new Error('HTTP GET '+resG.status);
    }catch(err){ lastErr=err; }
    try{
      const body=new URLSearchParams(); body.set('data', OP_QUERY);
      const res=await fetch(base,{method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'}, body});
      if(res.ok){ return await res.json(); }
      lastErr = new Error('HTTP POST '+res.status);
    }catch(err){ lastErr=err; }
  }
  throw lastErr||new Error('All Overpass mirrors failed');
}
function elementsToFeatures(elements){
  const buckets=new Map();
  for(const el of elements||[]){
    const tags=el.tags||{}; const code=tags['addr:postcode']||tags['postcode']||tags['postal_code'];
    if(!code || !isFreeCYPostcode(code)) continue;
    let lon=null,lat=null;
    if(el.type==='node'){ lon=el.lon; lat=el.lat; }
    else if(el.center){ lon=el.center.lon; lat=el.center.lat; }
    else if(el.bounds){ const b=el.bounds; lon=(b.minlon+b.maxlon)/2; lat=(b.minlat+b.maxlat)/2; }
    else if(Array.isArray(el.geometry) && el.geometry.length){
      try{ const coords = el.geometry.map(g=>[g.lon,g.lat]); const line = turf.lineString(coords); const c=turf.center(line).geometry.coordinates; lon=c[0]; lat=c[1]; }catch(e){}
    }
    if(typeof lon==='number'&&typeof lat==='number'&&isFinite(lon)&&isFinite(lat)){
      if(!buckets.has(code)) buckets.set(code, []);
      buckets.get(code).push([lon,lat]);
    }
  }
  const feats=[]; for(const [code,arr] of buckets){
    const sum=arr.reduce((a,c)=>[a[0]+c[0],a[1]+c[1]],[0,0]);
    const lon=sum[0]/arr.length, lat=sum[1]/arr.length;
    feats.push({type:'Feature',properties:{postcode:String(code)},geometry:{type:'Point',coordinates:[lon,lat]}});
  }
  return feats;
}
fetchAllBtn.onclick = async ()=>{
  try{
    statusDiv.textContent='Φέρνω όλους τους ΤΚ από Overpass…';
    const data = await fetchOverpassWithRetry();
    const feats = elementsToFeatures(data.elements);
    if(!feats.length) throw new Error('Δεν βρέθηκαν στοιχεία ΤΚ');
    const header='postcode,lat,lon\n';
    const body = feats.map(f=>`${f.properties.postcode},${f.geometry.coordinates[1]},${f.geometry.coordinates[0]}`).join('\n');
    const csv = header+body;
    localStorage.setItem('tk_offline_csv', csv);
    csvData = csv;
    loadFromCSVString(csv);
    statusDiv.textContent=`OK ✔︎ Cache ενημερώθηκε με ${feats.length} ΤΚ και φορτώθηκαν στο χάρτη.`;
  }catch(err){ 
    statusDiv.textContent='Σφάλμα Overpass: '+(err && err.message ? err.message : err);
    console.error('Overpass fetch error', err);
  }
};
clearCacheBtn.onclick = ()=>{ localStorage.removeItem('tk_offline_csv'); alert('Καθαρίστηκε η cache ΤΚ. Θα χρησιμοποιηθεί το ενσωματωμένο δείγμα.'); };

// ===== Self tests =====
(function runTests(){
  const lines=[]; const ok=(c,m)=>lines.push(`${c?'✔︎':'✖︎'} ${m}`);
  try{ ok(typeof L!=='undefined' && !!map, 'TC1: Leaflet αρχικοποιήθηκε'); }catch{ ok(false,'TC1: Leaflet'); }
  try{ const s='a\nb'; ok(s.split('\n').length===2, 'TC2: newline escape δουλεύει'); }catch{ ok(false,'TC2'); }
  try{ const rows=[{postcode:'1010',marker_id:1,distance_km:1.23}]; const header='postcode,marker_id,distance_km\n'; const body=rows.map(r=>`${r.postcode},${r.marker_id},${r.distance_km}`).join('\n'); ok((header+body).includes('\n'),'TC3: CSV builder'); }catch{ ok(false,'TC3'); }
  testsDiv.innerHTML = lines.map(x=>`<div>${x}</div>`).join('');
})();
</script>
</body>
</html>
